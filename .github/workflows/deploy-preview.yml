name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  deploy-preview:
    name: Build and Deploy Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: |
          cd client
          npm ci

      - name: Build React app
        run: |
          cd client
          npm run build

      - name: Create deployment directory
        run: |
          mkdir -p preview-deploy
          cp -r client/dist/* preview-deploy/

      - name: Generate preview info
        run: |
          echo "# Preview Build Information" > preview-deploy/BUILD_INFO.md
          echo "" >> preview-deploy/BUILD_INFO.md
          echo "- **PR Number**: ${{ github.event.pull_request.number }}" >> preview-deploy/BUILD_INFO.md
          echo "- **Branch**: ${{ github.head_ref }}" >> preview-deploy/BUILD_INFO.md
          echo "- **Commit**: ${{ github.sha }}" >> preview-deploy/BUILD_INFO.md
          echo "- **Build Time**: $(date)" >> preview-deploy/BUILD_INFO.md

      - name: Upload preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-${{ github.event.pull_request.number }}
          path: preview-deploy
          retention-days: 7

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const comment = `## ðŸš€ Preview Deployment
            
            Your preview build is ready!
            
            **Build Information:**
            - Branch: \`${{ github.head_ref }}\`
            - Commit: \`${{ github.sha }}\`
            - Build: [#${runId}](https://github.com/${{ github.repository }}/actions/runs/${runId})
            
            **Preview Artifacts:**
            - Download the preview build from the workflow artifacts
            - The build includes the complete React application
            
            **To test locally:**
            \`\`\`bash
            # Download the artifact
            # Extract to a directory
            # Serve with any static server:
            npx serve preview-deploy
            \`\`\`
            
            ---
            â™¿ Remember to test accessibility with keyboard navigation and screen readers!
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              description: 'Preview deployment successful',
              environment_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Company/Client model
model Company {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  apiKey      String   @unique
  webhookUrl  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  requests    Request[]
  
  @@map("companies")
}

// Creator model
model Creator {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  skills          String[] // e.g., ["ASL", "BSL", "video-editing"]
  isVerified      Boolean  @default(false)
  isAvailable     Boolean  @default(true)
  rating          Float    @default(0)
  completedProjects Int    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bids            Bid[]
  projects        Project[]
  
  @@map("creators")
}

// Video Request model
model Request {
  id              String   @id @default(cuid())
  companyId       String
  title           String
  description     String
  requirements    Json     // Flexible JSON for specific requirements
  serviceType     String   // e.g., "sign-language", "captioning", "video-editing"
  budget          Float?
  deadline        DateTime?
  status          RequestStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bids            Bid[]
  project         Project?
  statusLogs      RequestStatusLog[]
  
  @@index([companyId])
  @@index([status])
  @@map("requests")
}

enum RequestStatus {
  PENDING
  OPEN_FOR_BIDS
  BID_ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Bid model
model Bid {
  id          String   @id @default(cuid())
  requestId   String
  creatorId   String
  amount      Float
  proposal    String
  estimatedDays Int?
  status      BidStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  creator     Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@unique([requestId, creatorId])
  @@index([requestId])
  @@index([creatorId])
  @@map("bids")
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

// Project model (fulfillment)
model Project {
  id              String   @id @default(cuid())
  requestId       String   @unique
  creatorId       String
  status          ProjectStatus @default(IN_PROGRESS)
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  deliverableUrl  String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  request         Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  creator         Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@index([creatorId])
  @@map("projects")
}

enum ProjectStatus {
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REVISION_REQUIRED
  CANCELLED
}

// Request Status Log for tracking status changes
model RequestStatusLog {
  id          String   @id @default(cuid())
  requestId   String
  oldStatus   String?
  newStatus   String
  changedBy   String?
  notes       String?
  createdAt   DateTime @default(now())
  
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
  @@map("request_status_logs")
}

// Webhook Event Log
model WebhookEvent {
  id          String   @id @default(cuid())
  companyId   String?
  event       String   // e.g., "request.completed", "project.submitted"
  payload     Json
  url         String
  status      WebhookStatus @default(PENDING)
  attempts    Int      @default(0)
  lastAttempt DateTime?
  response    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([status])
  @@map("webhook_events")
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}
